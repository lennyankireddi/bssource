function InitGlobalview() {
    if (jQuery == undefined) {
        window.setTimeout(InitGlobalview, 33);
        return
    }
    jQuery.noConflict();
    DialogCSS();
    jQuery(document).ready(function() {
    	if(jQuery('#ctl00_PlaceHolderAdditionalPageHead_editmodestyles').length)
    		jQuery('body').addClass('edit');
    	else
    		jQuery('body').addClass('view');
		AdjustLeftNav();
		FixCarouselImage();
        SetFavIcon("/_catalogs/masterpage/Resources/favicon.ico");
		ToolsNavigation();
        /*GetMyProfile();
        AddNavSubtext();
        ConvertToMegaMenu();
        AddNavIcons();*/
        LanguageHandler();
	    SetChromeVisibility();
		RemoveSearchEnterEvent();
		GetFollowedSites();
		HideNavItemsByRole();
		/*SetPageHeader();*/
        SP.SOD.executeFunc("sp.js", "SP.ClientContext", function() {
            window.setTimeout(function() {
                if (jQuery("#MSOLayout_InDesignMode").val() != 1) {
                    SizeLeftNav();
                    HandleOOBLayouts();
                    /*SetEditFavoritesLink();*/
                    ResizeGalleryImages();
                    AccordionHandler();
                    TabHandler();
                    /*SP.SOD.executeOrDelayUntilScriptLoaded(DisplayFavorites, "SP.Ribbon.js");
                    jQuery("#sideNavBox .icon-reorder").click(function() {
                        jQuery("#DeltaPlaceHolderLeftNavBar").toggle()
                    })*/
                }
                window.setTimeout(function() {
                    HandleOOBLayouts();
					jQuery('#site_follow_button').unbind('click').attr('href','#favorite').removeAttr('onclick').click(function(){
						addFavorite(GetFollowUrl(jQuery(this)), GetFollowTitle(jQuery(this)));
					});
					jQuery(document).on('click', '.icon-star-empty',function(){
						addFavorite(GetFollowUrl(jQuery(this)), GetFollowTitle(jQuery(this)));
						jQuery(this).addClass('icon-star').removeClass('icon-star-empty');
						//FollowDocument(GetFollowUrl(jQuery(this)), false, jQuery(this));
					});
					jQuery(document).on('click','.icon-star',function(){
						var url = GetFollowUrl(jQuery(this));
						for(var i = 0;i < favorites.length; i++)
						{
							if(favorites[i].url == url)
							{
								removeFavorite(favorites[i].id, jQuery(this));
								break;
							}
						}
						//stopFollowDocument(GetFollowUrl(jQuery(this)),1);
					});
                }, 200)
            }, 100)
        })
    })
}

function RemoveSearchEnterEvent()
{
	jQuery('input.ms-srch-sb-prompt').unbind('keypress').unbind('keydown').unbind('keyup').removeAttr('onkeypress').removeAttr('onkeydown');
	jQuery(document).on("keyup", ".search-everything input", function(e) {
		if (e.which == 13 && jQuery(this).val().length > 0) {
			window.location = "/search/Pages/results.aspx?k=" + jQuery(this).val();
		}
		else if (jQuery(this).val().length > 2) {
			RichDocumentSearch(jQuery(this));
		} 
	});
	jQuery(document).on("click", ".ms-srch-sb-searchLink", function(e){
		window.location = "/search/Pages/results.aspx?k=" + jQuery(".search-everything input").val();
	});
	jQuery(document).on("click", ".Person", function(e) {
		window.location = jQuery(this).attr("href")
	});
}

function SetChromeVisibility()
{
	jQuery.ajax({
			url: _spPageContextInfo.webAbsoluteUrl + "/_api/web/getuserbyid(" + _spPageContextInfo.userId + ")",
			type: "GET",
			headers: { "accept" : "application/json;odata=verbose" },
			success:function(e){
                //sample login names
                //windows claims = "i:0#.w|idmresc\spext_setup"
                //SAML claims - "i:0e.t|acs dev|amanda.stern@beamsuntorydev.com"
				var loginName = e.d.LoginName;
                if (loginName.indexOf("i:0#.w") > -1)
                {
                    document.getElementById("suiteBar").style.display = "block";
                }
                else
                {
                    document.getElementById("suiteBar").style.display = "none";                   
                }
			},
			error:function(e) {}
		});
}


function GetFollowUrl(element)
{
	var url = window.location.href;
	var p = jQuery(element).parent();
	if(jQuery(p).hasClass('folderName'))
		return url + "?section=" + jQuery(element).parent().find('span').text();
	else if(jQuery(p).hasClass('doc'))
	{
		url = jQuery(p).find('a').attr('href');
		if(url.indexOf('.com/') > 1)
			return url.substring((url.indexOf('.com/') + 4));
		return url;
	}
	return url;
}

var favorites = [];
function GetFollowedSites()
{
	jQuery.ajax({
		url:"/_api/web/lists/GetByTitle('Favorites')/Items?$select=ID,URL,Order,Author/Id&$expand=Author&$filter=(Author/Id eq " + _spPageContextInfo.userId + ")&$orderby=Order asc",
		type:"GET",
		headers:{Accept:"application/json;odata=verbose"},
		success:function(d)
		{
			jQuery.each(d.d.results, function(i,n)
			{
				var fav = {
					title:n.URL.Description,
					url:n.URL.Url,
					id:n.ID
				};
				favorites.push(fav);
			});
			return favorites;
		},error:function(d) {
			console.log(JSON.stringify(d));
			return favorites;
		}
	});
}

function GetFollowTitle(element)
{
	var title = document.title;
	var p = jQuery(element).parent();
	if(jQuery(p).hasClass('folderName'))
		return jQuery(element).parent().find('span').text();
	else if(jQuery(p).hasClass('doc'))
		return jQuery(p).find('a').text();
	return title;
}

function AdjustLeftNav()
{
	if(jQuery('.connectPage').length)
	{
		jQuery('#contentBox').addClass('publishingPage');
		jQuery('#s4-content').css('margin-left','0px !important');
		jQuery('#DeltaPlaceHolderMain').css('width','100% !important');
		jQuery('#contentBox').css('margin-right','0px');
		jQuery('#sideNavBox').css('display','none');
	}
}

function ToolsNavigation()
{
	jQuery.ajax({
			url: "/_api/web/lists/GetByTitle('Toolbox')/Items?$select=URL",
			type: "GET",
			headers: {"accept": "application/json;odata=verbose",},
			success:function(e){
				var r = jQuery('#DeltaTopNavigation ul.root > li.static').eq(2);
				jQuery(r).addClass('dynamic-children').find('a').first().addClass('dynamic-children');
				var html = '<ul class="dynamic">';
				jQuery.each(e.d.results,function(i,t){
					var url = {group:t.Categories,title: t.URL.Description,url: t.URL.Url};
					html += 
						'<li class="dynamic">' +
							'<a target="_blank" class="dynamic menu-item ms-core-listMenu-item ms-displayInline ms-navedit-linkNode" tabindex="0" href="' + t.URL.Url + '">' +
								'<span class="additional-background ms-navedit-flyoutArrow">' +
									'<span class="menu-item-text">' + t.URL.Description + '</span>' +
								'</span>' +
							'</a>' +
						'</li>';
				});
				html += '</ul>';
				jQuery(r).append(html);
			},
			error:function(e) {}
		});
}

function IsFollowed(url, pageElement)
{
	var pageUrl = _spPageContextInfo.webServerRelativeUrl;
	if(pageUrl.indexOf('.aspx') == -1)
		pageUrl += "/Pages/default.aspx?section=";
	if(pageElement)
		url = pageUrl + url;
	jQuery.ajax({
        url: _spPageContextInfo.webServerRelativeUrl + "/_api/social.following/isfollowed",
        method: "POST",
        headers: {
            "Accept": "application/json;odata=verbose",
			"content-type":"application/json;odata=verbose",
			"X-RequestDigest":jQuery("#__REQUESTDIGEST").val()
        },
		data: JSON.stringify({
			"actor":{
				"__metadata":{
					"type":"SP.Social.SocialActorInfo"
				},
				"ActorType":1,
				"ContentUri":url,
				"Id":null
			}
		}),
        success: function(e) {
			return e.d.IsFollowed;
		},
		error:function(e){
			return false;
		}
	});
}

function stopFollowDocument(url, actorType) {
    jQuery.ajax( {
        url: _spPageContextInfo.siteServerRelativeUrl + "/_api/social.following/stopfollowing",
        type: "POST",
        data: JSON.stringify( { 
            "actor": {
                "__metadata": {
                    "type":"SP.Social.SocialActorInfo"
                },
                "ActorType":actorType,
                "ContentUri":url,
                "Id":null
            } 
        } ),
        headers: { 
            "accept":"application/json;odata=verbose",
            "content-type":"application/json;odata=verbose",
            "X-RequestDigest":jQuery("#__REQUESTDIGEST").val()
        },
        success: function () { 
            //alert('The user has stopped following the document.');
			jQuery(this).find("icon-heart-open").addClass("icon-heart").removeClass("icon-heart-open");
        },
        error: function (e) { console.log("Unable to follow document: " + JSON.stringify(e));}
    } );
}

function addFavorite(url, title,element)
{
	console.log("addFavorite (func) - URL: " + url + " Title: " + title + " Element: " + element);
	var d = {
				'__metadata':
				{
					'type':'SP.Data.FavoritesListItem'
				},
				'URL':{
					'__metadata':{'type':'SP.FieldUrlValue'},
					'Description':title,
					'Url':url
				}
			};
	jQuery.ajax({
		url:"/_api/web/lists/GetByTitle('Favorites')/items",
		type:"POST",
		headers:{
			"accept":"application/json;odata=verbose",
            "X-RequestDigest":jQuery("#__REQUESTDIGEST").val(),
			"content-type":"application/json;odata=verbose"
		},
		data: JSON.stringify(d),
		success:function(e) {
			if(typeof(element) != 'undefined')
				jQuery(element).addClass('icon-star').removeClass('icon-star-empty');
		},
		error:function(e)
		{
			console.log(JSON.stringify(e));
		}
	});
}

function removeFavorite(id, element)
{
	jQuery.ajax({
		url:"/_api/web/lists/GetByTitle('Favorites')/items(" + id + ")",
		type:"POST",
		headers:{
			"accept":"application/json;odata=verbose",
            "X-HTTP-Method":"DELETE",
            "X-RequestDigest":jQuery("#__REQUESTDIGEST").val(),
			"IF-MATCH":"*"
		},
		success:function(e) {
			if(typeof(element) != undefined)
				jQuery(element).addClass('icon-star-empty').removeClass('icon-star');
		},
		error:function(e)
		{
			console.log(JSON.stringify(e));
		}
	});
}

function CheckFollowedDocuments()
{
	jQuery.each('.folder', function(e,t){
		jQuery.each(jQuery(this).attr('class').split(' '), function(x,n)
		{
			if(IsFollowed(n,true))
				jQuery(this).find('icon-star-empty').addClass('icon-star').removeClass('icon-star-empty');
		});
	});
}

function FollowDocument(url,pageElement,sourceElement)
{
	var pageUrl = _spPageContextInfo.webServerRelativeUrl;
	if(pageUrl.indexOf('.aspx') == -1)
		pageUrl += "/Pages/default.aspx?section=";
	if(pageElement)
		url = pageUrl + url;
	jQuery.ajax({
        url: _spPageContextInfo.siteServerRelativeUrl + "/_api/social.following/follow",
        method: "POST",
        headers: {
            "Accept": "application/json;odata=verbose",
			"content-type":"application/json;odata=verbose",
			"X-RequestDigest":jQuery("#__REQUESTDIGEST").val()
        },
		data: JSON.stringify({
			"actor": {
				"__metadata":{
					"type":"SP.Social.SocialActorInfo"
				},
				"ActorType":1,
				"ContentUri":url,
				"Id":null
			}
		}),
        success: function(e) {
			console.log(JSON.stringify(e));
			jQuery(sourceElement).addClass('icon-star').removeClass('icon-star-empty');
		},
		error:function(e){
			console.log(JSON.stringify(e));
		}
	});
}

function ModifyToInternationalDate()
{
	jQuery('.program .date').each(function() 
	{
		jQuery(this).text(ConvertDateFormatDMY(jQuery(this).text()));
	});
}

function ConvertDateFormatDMY(date)
{
	var d = date.split('/');
	return d[1] + '/' + d[0] + '/' + d[2];
}

function HideNavItemsByRole()
{
	//hide rackhouse navigation for trade users
	if (claimsJSONMap.SuccessFactorsRoleID !== undefined)
	{
		console.log('user type: ' + claimsJSONMap.SuccessFactorsRoleID);
		if(claimsJSONMap.SuccessFactorsRoleID === "Trade_ID")
		{
			//hide rackhouse
			var rackhouse = jQuery('#DeltaTopNavigation ul.root > li.static:nth-child(2)').css('display','none');
		}
	}

}
function UpdateNav(path,ourBrandsText,toolboxText,rackhouseText)
{
	// this function overwrites the text values for each navigation node with translated text
	// this function also replaces the connect path with the appropriate language path
	var brands = jQuery('#DeltaTopNavigation ul.root > li.static:nth-child(1)');
	var link = jQuery(brands).find('a.menu-item');

	var rackhouse = jQuery('#DeltaTopNavigation ul.root > li.static:nth-child(2)');
	var rlink = jQuery(rackhouse).find('a.menu-item');

	jQuery(link).attr('href', jQuery(link).attr('href').replace('/connect',path));
	jQuery(brands).find('.menu-item-text').text(ourBrandsText);

	jQuery(rlink).attr('href', jQuery(rlink).attr('href').replace('/connect',path));
	jQuery(rackhouse).find('.menu-item-text').text(rackhouseText);

	jQuery('#DeltaTopNavigation ul.root > li.static:nth-child(3) .menu-item-text').text(toolboxText);
}

function LanguageHandler()
{
	if(_spPageContextInfo.currentCultureName != 'en-US'){
		jQuery('#languageSelect .en-US').removeClass('active');
		jQuery('#languageSelect' + ' .' + _spPageContextInfo.currentCultureName).addClass('active');
	}
	switch(_spPageContextInfo.currentCultureName)
	{
		case "en-US":
			jQuery('#site_follow_button .ms-promotedActionButton-text').text("Favorite");
		break;
		case "es-MX":
			jQuery('#site_follow_button .ms-promotedActionButton-text').text("Favorito");
			UpdateNav('/es','Nuestras Marcas','Herramientas','Rackhouse');
			ModifyToInternationalDate();
		break;
		case "de-DE":
			jQuery('#site_follow_button .ms-promotedActionButton-text').text("Favorit");
			UpdateNav('/de','Unsere Marken','Werkzeugkasten','Rackhouse');
			ModifyToInternationalDate();
		break;
		case "fr-CA":
			jQuery('#site_follow_button .ms-promotedActionButton-text').text("Préféré");
			UpdateNav('/fr','Nos Marques','Outils','Rackhouse');
			ModifyToInternationalDate();
		break;
		case "pt-BR":
			jQuery('#site_follow_button .ms-promotedActionButton-text').text("Favoritos");
			UpdateNav('/pt','Nossas marcas','Ferramentas','Rackhouse');
			ModifyToInternationalDate();
		break;
		case "pt-PT":
			jQuery('#site_follow_button .ms-promotedActionButton-text').text("Favoritos");
			UpdateNav('/pt','Nossas marcas','Ferramentas','Rackhouse');
			ModifyToInternationalDate();
		break;
		case "zh-CN":
			jQuery('#site_follow_button .ms-promotedActionButton-text').text("我的最愛");
			UpdateNav('/zhcn','我的最愛','工具','Rackhouse');
			ModifyToInternationalDate();
		break;
		case "zh-HK":
			jQuery('#site_follow_button .ms-promotedActionButton-text').text("我的最愛");
			UpdateNav('/zhhk','我們的品牌','工具','Rackhouse');
			ModifyToInternationalDate();
		break;
		case "ru-RU":
			jQuery('#site_follow_button .ms-promotedActionButton-text').text("Избранное");
			UpdateNav('/ru','Бренды','Инструменты','Rackhouse');
			ModifyToInternationalDate();
		break;
		case "pl-PL":
			jQuery('#site_follow_button .ms-promotedActionButton-text').text("Moje ulubione");
			UpdateNav('/pl','Nasze Marki','Narzędzia','Rackhouse');
			ModifyToInternationalDate();
		break;
		case "ja-JP":
			jQuery('#site_follow_button .ms-promotedActionButton-text').text("お気に入り");
			UpdateNav('/ja','当社のブランド','ツール','Rackhouse');
			ModifyToInternationalDate();
		break;
	}
	var um = jQuery('.userMenus');
	jQuery('#RibbonContainer-TabRowRight').prepend(jQuery(um).html());
	jQuery(um).remove();
	jQuery('#languageSelect').click(function()
	{
		if(jQuery(this).hasClass('active'))
			jQuery(this).removeClass('active');
		else
			jQuery(this).addClass('active');
	});
	jQuery(document).click(function(e){
		if(!jQuery(e.target).closest('#languageSelect').length && jQuery('#languageSelect').hasClass('active')){
			jQuery('#languageSelect').removeClass('active');
		}
	});
}

function FixCarouselImage(){
	window.setTimeout(function(){
		jQuery('img.cbs-largePictureImg').each(function(i,t){
			jQuery(t).attr('src',jQuery(t).attr('src').split('?')[0]);
		});
		//console.log('fixed carousel');
		},
	300);
}

function AddWebPartIcons() {
	var html = '<i class="fa fa-share-square-o icon-share"></i>';
	jQuery('h2.ms-webpart-titleText nobr > span:first-child').append(html);
}

function SetPageHeader() {
	if(jQuery('.pageImage')){
		jQuery('#s4-titlerow').append('<div class="pageHeaderBackground container"></div>');
		var bgUrl = jQuery('.pageImage .ms-rtestate-field > img').attr('src');
		jQuery('.pageHeaderBackground').css("background-image", "url('" + bgUrl + "')");
	}
}

function DialogCSS() {
    if (window.location.search.substring(1).indexOf("IsDlg") != -1) jQuery("#responsiveCss").attr("href", jQuery("#responsiveCss").attr("href") + "?mode=dialog");
    else jQuery("#responsiveCss").attr("href", jQuery("#responsiveCss").attr("href") + "?mode=normal")
}

function waitForjQuery() {
    if (typeof jQuery == undefined) window.setTimeout(waitForjQuery, 100);
    else InitGlobalview()
}

function SetFavIcon(e) {
    jQuery("#favicon").attr("href", e).attr("type", "image/png")
}

function AddNavIcons() {
    jQuery("#DeltaTopNavigation li.static > ul.dynamic > li.dynamic > a").each(function(e) {
        var t = jQuery(this).find("span.menu-item-text");
        var n = GetIcon(jQuery(t).text());
        if (n == "") n = icons["other"];
        jQuery(t).parent().prepend("<span class='" + n + "'></span>")
    })
}

function ConvertToMegaMenu() {
    var e = "";
    if (!SupportsCSS("column-count") && !SupportsCSS("ColumnCount")) e = "IE";
    /*jQuery("#DeltaTopNavigation ul.root > li.dynamic-children > ul").each(function(t) {
        var n = jQuery(this).parent().find(">:first-child .menu-item-text").contents().filter(function() {
            return this.nodeType == 3
        })[0].nodeValue;
        if (n == "My HR") 
        {
        	//ie11 uses an auto height for column-count which in some cases (like hr) makes columns collapse in to fewer columns with lots of white space
        	if(e != "IE" && window.navigator.appVersion.indexOf("MSIE 10.0") > -1)
        		jQuery(this).addClass(e + "ThreeColumns").css("height","400px").css("min-width","700px !important");
        	else
        		jQuery(this).addClass(e + "FourColumns");
        }
        else if (n == "Company") jQuery(this).addClass("IEFourColumns");
        else if (n == "Reference Library") jQuery(this).addClass(e + "ThreeColumns");
        else if (n == "Business Groups") jQuery(this).addClass("IEThreeColumns");
        else {
            var r = jQuery(this).find("li.dynamic span.menu-item-text").length;
            if (r > 12 && r < 20) jQuery(this).addClass(e + "TwoColumns");
            else if (r > 19 && r < 35) jQuery(this).addClass(e + "ThreeColumns");
            else if (r > 34) jQuery(this).addClass(e + "FourColumns")
        }
    })*/
}

function TabHandler() {
    jQuery(".tab").click(function() {
        jQuery(".tab").removeClass("selected");
        jQuery(this).addClass("selected");
        jQuery(".cbs-TabContent").html(jQuery(this).find(".cbs-Content").html())
    });
    jQuery(".tab:first").trigger("click")
}

function AccordionHandler() {
    jQuery(".cbs-AccordionTitle").click(function() {
        jQuery(".SelectedItem.cbs-AccordionContent").removeClass("SelectedItem");
        jQuery(this).find(".cbs-AccordionContent").addClass("SelectedItem")
    })
}

function DisplayFavorites() {
    jQuery("#embedFavorites").attr("src", "/teams/GTS/SitePages/MyFavoritePlaces.aspx?IsDlg=1")
}

function SupportsCSS(e) {
    var t = document.createElement("div");
    var n = "khtml ms o Moz webkit".split(" ");
    if (e in SupportedFunctions) return true;
    if (e in t.style) {
        SupportedFunctions[e] = "true";
        return true
    }
    for (i = 0; i < n.length; i++) {
        if (n[i] + "-" + e in t.style || n[i] + e in t.style) {
            SupportedFunctions[e] = "true";
            return true
        }
    }
    return false
}

function GetIcon(e) {
    e = e.toLowerCase();
    var t = "";
    if (e.indexOf(" ") != -1) {
        var n = e.split(" ");
        for (var r = 0; r < n.length; r++) {
            t = GetIcon(n[r]);
            if (t != "") return t
        }
    } else if (e in icons) {
        return icons[e]
    }
    return t
}

function FixVariationsGlobalLinks()
{
	var loc = window.location.href.split(window.location.hostname)[1].split('/')[1];
	jQuery('#DeltaTopNavigation li.static > a.ms-core-listMenu-item').each(function(e){
		jQuery(this).attr('href', '/' + loc + jQuery(this).attr('href'));
	});
}

function ResizeGalleryImages() {
    if (jQuery(".flickr-widget .cbs-largePictureImageContainer").length == 0) window.setTimeout(ResizeGalleryImages, 100);
    jQuery(".flickr-widget .cbs-largePictureImg").each(function(e) {
        var t = jQuery(this).attr("src").split("?width")[0];
        var n = jQuery(this).attr("alt");
        jQuery(this).attr("src", t)
    })
}

function HandleOOBLayouts() {
    if (jQuery(".welcome.welcome-links").length || jQuery("#DeltaPlaceHolderMain .article.article-body").length) {
        jQuery("#sideNavBox").css("margin-left", "0px");
        jQuery("#contentRow").addClass("container");
        if (jQuery(".article").length) {
            jQuery("#contentBox").css("min-height", jQuery(".article").height() + 100 + "px");
            if (jQuery("#contentBox").height() > jQuery("#sideNavBox").height()) jQuery("#sideNavBox").css("min-height", jQuery(".article").height() + 100 + "px");
            SizeLeftNav()
        } else jQuery("#contentBox").width(jQuery(".container").width() - 245);
        if (jQuery("#WebPartctl00_ctl46_g_6307756c_8d5e_4dd7_9039_3111908ac0ce").length) jQuery("#WebPartctl00_ctl46_g_6307756c_8d5e_4dd7_9039_3111908ac0ce").css("height", "100% !important").css("width", "100% !important")
    }
}

function SizeLeftNav() {
    var e = jQuery("#contentBox").height() + 150;
    var t = jQuery("#sideNavBox").height() + 75;
    jQuery("#contentRow").css("min-height", e + "px");
    jQuery("#contentRow").css("min-heihgt", t + "px")
}

function FixSiteContents() {
    if (jQuery("#appsTable.ms-viewlsts").length || jQuery("#DeltaPlaceHolderMain > table.propertysheet").length) {
        jQuery("#contentBox").css("display", "block").css("margin-left", "240px").css("margin-bottom", "40px");
        jQuery("#sideNavBox").addClass("FloatLeft").css("padding-left", "20px")
    }
}

function FixMDSPages() {
    if (window.location.pathname.indexOf("start.aspx") > 0) {
        if (jQuery("#contentBox").height < 200) window.setTimeout(FixMDSPages, 100);
        else if (jQuery("#DeltaPlaceHolderMain #ctl00_PlaceHolderMain_WikiField").length) FixWikiPages();
        else if (jQuery("#DeltaPlaceHolderMain .ms-listviewtable").length) AdjustMDSPages(jQuery("#DeltaPlaceHolderMain div[id^='WebPart'] > table").height());
        else if (jQuery("#DeltaPlaceHolderMain #AsynchronousViewDefault_CalendarView").length) {
            jQuery("#DeltaPlaceHolderMain").css("width", "100%");
            AdjustMDSPages(jQuery("#DeltaPlaceHolderMain #AsynchronousViewDefault_CalendarView").height())
        }
    }
}

function AdjustMDSPages(e) {
    jQuery("#sideNavBox").height(e).addClass("FloatLeft").css("padding-left", "20px");
    jQuery("#contentBox").height(e).css("display", "block").css("margin-left", "240px").css("margin-bottom", "40px");
    jQuery("#contentRow").css("min-width", "1597px")
}

function FixWikiPages() {
    var e = jQuery(".ms-wikicontent.ms-rtestate-field").css("padding-bottom", "350px").height();
    if (e < 400) window.setTimeout(FixWikiPages, 100);
    else AdjustMDSPages(e)
}

function AddNavSubtext() {

    jQuery("#DeltaTopNavigation li.static > a").each(function(e) {
        var t = jQuery(this).attr("title");
        if (t != undefined) jQuery(this).find("span.menu-item-text").append("<div class='subtext'>" + t + "</div>")
    })
}

function GetMyProfile() {
    jQuery.ajax({
        url: "https://slalomsf.sharepoint.com/_api/SP.UserProfiles.PeopleManager/GetMyProperties",
        type: "GET",
        headers: {
            Accept: "application/json;odata=verbose"
        },
        success: function(e) {
            myprofile = e.d;
            mysiteUrl = e.d.PersonalUrl
        },
        error: function(e) {}
    })
}

function SetEditFavoritesLink() {
    if (myprofile == undefined) {
        window.setTimeout(SetEditFavoritesLink, 100);
        return
    }
    jQuery("#personalLinks").attr("href", myprofile.PersonalUrl + "/_layouts/15/quiklnch.aspx")
}

function RichPeopleSearch(e) {
    var t = jQuery(e).val();
    t = t.replace(" ", "* *");
    t = t + "*";
    jQuery.ajax({
        url: "https://slalomsf.sharepoint.com/sites/silver/_api/search/query?querytext='" + t + "'&querytemplate='PreferredName:{searchterms}'&TrimDuplicates='false'&selectproperties='OriginalPath,AboutMe%2cBaseOfficeLocation%2cDepartment%2cJobTitle%2cPictureURL%2cPreferredName%2cWorkEmail%2cWorkPhone'&sourceid='b09a7990-05ea-4af9-81ef-edfab16c4e31'",
        method: "GET",
        headers: {
            Accept: "application/json;odata=verbose"
        },
        success: function(e) {
            var t = "";
            jQuery.each(e.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results, function(e, n) {
                var r;
                var i;
                var s;
                var o;
                var u;
                var a;
                var f;
                var l;
                var c;
                jQuery.each(n.Cells.results, function(e, t) {
                    if (t.Key == "WorkEmail") i = t.Value;
                    else if (t.Key == "WorkPhone") r = t.Value;
                    else if (t.Key == "BaseOfficeLocation") u = t.Value;
                    else if (t.Key == "AboutMe") o = t.Value;
                    else if (t.Key == "Department") l = t.Value;
                    else if (t.Key == "JobTitle") a = t.Value;
                    else if (t.Key == "PictureURL") f = t.Value;
                    else if (t.Key == "PreferredName") s = t.Value;
                    else if (t.Key == "OriginalPath") c = t.Value
                });
                t += '<div class="Person" href="' + c + '"><span>' + s + "</span>";
                if (f != undefined && r != "null") t += '<div class="picture"><img src="' + f + '"/></div>';
                if (l != undefined && r != "null") t += '<div class="department"><span>Department: </span><span>' + l + "</span></div>";
                if (a != undefined && r != "null") t += '<div class="title"><span>Title: </span><span>' + a + "</span></div>";
                if (r != undefined && r != "null") t += '<div class="workPhone">' + r + "</div>";
                if (i != undefined && i != "null") t += '<div class="workEmail"><a href="mailto:' + i + '">' + i + "</a></div>";
                if (u != undefined && r != "null") t += '<div class="office"><span>Office: </span><span>' + u + "</span></div>";
                if (r != undefined && r != "null") o += '<div class="aboutme"><span>About Me: </span><span>' + o + "</span></div>";
                t += "</div>";
                showingResults = true
            });
            jQuery(".gv-emp-results").html(t).fadeIn("fast")
        },
        error: function(e) {}
    })
}
var loadingjQuery = false;
var ticker = 0;
waitForjQuery();
var icons = {};
icons["archive"] = "icon-archive";
icons["chart"] = "icon-bar-chart";
icons["projects"] = "icon-bar-chart";
icons["blog"] = "icon-comments";
icons["star"] = "icon-star";
icons["asterisk"] = "icon-asterisk";
icons["location"] = "icon-compass";
icons["travel"] = "icon-plane";
icons["menu"] = "icon-reorder";
icons["work"] = "icon-folder-open";
icons["building"] = "icon-building";
icons["communication"] = "icon-bullhorn";
icons["news"] = "icon-rss-sign";
icons["twitter"] = "icon-twitter-sign";
icons["facebook"] = "icon-facebook-sign";
icons["key"] = "icon-key";
icons["book"] = "icon-book";
icons["reference"] = "icon-book";
icons["print"] = "icon-print";
icons["calendar"] = "icon-calendar";
icons["calendars"] = "icon-calendar";
icons["gallery"] = "icon-camera";
icons["photo"] = "icon-camera";
icons["social"] = "icon-comment-alt";
icons["tools"] = "icon-gears";
icons["download"] = "icon-download-alt";
icons["optic"] = "icon-eye-open";
icons["vision"] = "icon-eye-open";
icons["optics"] = "icon-eye-open";
icons["video"] = "icon-film";
icons["activity"] = "icon-sun";
icons["group"] = "icon-group";
icons["hr"] = "icon-group";
icons["person"] = "icon-user";
icons["health"] = "icon-heart";
icons["star"] = "icon-star";
icons["info"] = "icon-info-sign";
icons["world"] = "icon-globe";
icons["help"] = "icon-stethoscope";
icons["legal"] = "icon-legal";
icons["business"] = "icon-globe";
icons["vsp"] = "icon-globe";
icons["technology"] = "icon-laptop";
icons["howdoi"] = "icon-question-sign";
icons["how"] = "icon-question-sign";
icons["training"] = "icon-info-sign";
icons["wiki"] = "icon-info";
icons["security"] = "icon-lock";
icons["other"] = "icon-columns";
var SupportedFunctions = {};
var myprofile;

var showingResults = false;
jQuery(document).mouseup(function(e) {
    if (showingResults) {
        var t = jQuery(".gv-doc-results");
        if (!t.is(e.target)) t.hide()
    }
});
jQuery(".people-search .ms-srch-sb-searchLink").click(function(e) {
    window.location = "/search/Pages/peopleresults.aspx?k=" + jQuery(".people-search input").val().replace(" ", "* *")
})

jQuery(".search-everything .ms-srch-sb-searchLink").click(function(e) {
    window.location = "/search/Pages/results.aspx?k=" + jQuery(".search-everything input").val().replace(" ", "* *")
})

function GetDocIcon(extension)
{
	switch(extension)
	{
		case "aspx":
			return "/Style%20Library/Images/doc-icons/icgen.gif";
		case "pptx":
			return "/Style%20Library/Images/doc-icons/icpptx.png";
		case "ppt":
			return "/Style%20Library/Images/doc-icons/icpptx.png";
		case "doc":
			return "/Style%20Library/Images/doc-icons/icdoc.png";
		case "docx":
			return "/Style%20Library/Images/doc-icons/icdocx.png";
		case "xls":
			return "/Style%20Library/Images/doc-icons/icxls.png";
		case "xlsx":
			return "/Style%20Library/Images/doc-icons/icxlsx.png";
		case "xlsb":
			return "/Style%20Library/Images/doc-icons/icxlsx.png";
		case "pdf":
			return "/Style%20Library/Images/doc-icons/icpdf.png";
		case "jpg":
			return "/Style%20Library/Images/doc-icons/icjpg.gif";
		case "png":
			return "/Style%20Library/Images/doc-icons/icjpg.gif";
		case "mp4":
			return "/Style%20Library/Images/doc-icons/video.png";
		case "mov":
			return "/Style%20Library/Images/doc-icons/video.png";
		default:
			return "/Style%20Library/Images/doc-icons/icgen.gif";
	}
}

function GetFileType (ext) {
	switch (ext) {
		case "ASPX":
			return "Page";
			break;
		case "PPTX":
			return "PowerPoint";
			break;
		case "PPT":
			return "PowerPoint";
			break;
		case "DOCX":
			return "Document";
			break;
		case "DOC":
			return "Document";
			break;
		case "XLSX":
			return "Spreadsheet";
			break;
		case "XLSX":
			return "Spreadsheet";
			break;
		case "PDF":
			return "PDF";
			break;
		case "JPG":
			return "Image";
			break;
		case "PNG":
			return "Image";
			break;
		case "MP4":
			return "Video";
			break;
		case "MOV":
			return "Video";
			break;
		default:
			return "File";
			break;
	}
}

function IsOfficeDocument(extension) {
	switch(extension.toUpperCase()) {
		case "PPT":
			return true;
			break;
		case "PPTX":
			return true;
		case "DOC":
			return true;
			break;
		case "DOCX":
			return true;
		case "XLS":
			return true;
			break;
		case "XLSX":
			return true;
		default:
			return false;
	}
}

function IsVideoFile(extension) {
	switch (extension.toUpperCase()) {
		case "MP4":
			return true;
		case "MOV":
			return true;
		default:
			return false;
	}
}

function RichDocumentSearch(e) {
    var t = jQuery(e).val();
	
	//var url = window.location.protocol + "//connectadmin.beamsuntory.com"; //" + window.location.hostname - for some reason no rows are returned when using an aam address, but if you use the default web app address as the path it works fine and the results are mapped to the currently accessed web
	var url = _spPageContextInfo.siteAbsoluteUrl; // leveraging the siteAbsoluteUrl instead of windows.location.hostname.  Will have to ensure that this is working properly in prod	

	var subsite = _spPageContextInfo.webServerRelativeUrl;
	if(subsite != "/")
		subsite = _spPageContextInfo.webServerRelativeUrl.split('/')[1];
	else
		subsite = "";

    //t = t.replace(" ", "*");
    t = t + "*";
	
	//var searchUrl = "/_api/search/query?querytext='((filename:" + t + " IsDocument:True) OR (*" + jQuery(e).val().replace(" ","") + "* contentclass:STS_Web)) AND Path:" + url + "/" + subsite + "'&selectproperties='Path,ServerRedirectedURL,Title,FileName,FileExtension'";
	var pathRemovals = String.format("-Path:{0}/SiteAssets -Path:{0}/CONNECT/SiteAssets -Path:{0}/backgroundimages", _spPageContextInfo.siteAbsoluteUrl);
	console.log(pathRemovals);
	var searchUrl = "/_api/search/query?querytext='((filename:" + t + ") OR (brand:" + t + ") OR (beamconnectcategory:"+ t +")) AND (isDocument:true) " + pathRemovals + "'&selectproperties='Path,ServerRedirectedURL,Title,FileName,FileExtension'";
	var searchTerm = t;
	
    jQuery.ajax({
        url: searchUrl,
        method: "GET",
        headers: {
            Accept: "application/json;odata=verbose"
        },
        success: function(e) {
            var t = "";
            jQuery.each(e.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results, function(e, n) {
				t += '<div class="docResult">';
				var icon = "/_layouts/15/images/icgen.gif";
				var title;
				var url;
				var isDocument = false;
				var filename;
                jQuery.each(n.Cells.results, function(x,y){
					if(y.Key == "FileExtension")
					{
						if(y.Value != "aspx")
							isDocument = true;
						icon = GetDocIcon(y.Value);
					}
					if(y.Key == "Title")
						title = y.Value;
					if(y.Key == "ServerRedirectedURL" && y.Value) {
						url = y.Value;
					}
					if(y.Key == "Path" && typeof(url) == 'undefined')
						url = y.Value;
					if(y.Key == "FileName")
						filename = y.Value;
				});
				if(isDocument)
					title = filename;
				t += '<span class="docIcon"><img src="' + icon + '"/></span><span class="docUrl"><a href="' + url + '">' + title + '</a></span>';
				t += '</div>';
                showingResults = true
            });
			
			searchTerm = searchTerm.replace("*", "");
			t += '<div class="srch-view-more"><a href="/search/pages/results.aspx?k=' + searchTerm + '">View more...</a></div>';
            jQuery(".gv-doc-results").html(t).fadeIn("fast");
        },
        error: function(e) {}
    })
}





