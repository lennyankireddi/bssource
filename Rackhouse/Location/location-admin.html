<script type="text/javascript" charset="utf8" src="/_catalogs/masterpage/resources/jquery.easyeditor.js"></script>
<script type="text/javascript" charset="utf8" src="/_catalogs/masterpage/resources/jquery.dataTables.min.js"></script>
<link rel="stylesheet" type="text/css" href="/_catalogs/masterpage/resources/easyeditor.css">

<div class="container-fluid beam">
    <div class="row">
        <div class="col-xs-12">
            <div class="form-horizontal">
                <div>
                    <fieldset>
                        <!-- Text input-->
                        <div class="form-group">
                            <h3><label class="col-md-2 control-label" for="txtTitle">Location Name</label></h3>
                            <div class="col-md-4">
                                <input class="form-control input-md" id="txtTitle" placeholder="Event Name" type="text">
                            </div>
                        </div>

                        <div class="form-group">
                            <h3><label class="col-md-2 control-label" for="txtLocation">Location</label></h3>
                            <div class="col-md-4">
                                <input class="form-control input-md" id="txtLocation" placeholder="Location" type="text">
                            </div>
                        </div>

                        <div class="form-group">
                            <div>
                                <h3><label class="col-md-2 control-label">Position</label></h3>
                            </div>
                            <div class="col-md-4">
                                <div class="form-double">
                                    <div class="form-group  col-sm-6">
                                        <label for="datepicker-start">Latitude</label>
                                        <div><input class="form-control input-sm" placeholder="Lat" type="text"></div>
                                    </div>
                                    <div class="form-group  col-sm-6">
                                        <label for="datepicker-end">Longitude:</label>
                                        <div><input class="form-control input-sm" placeholder="Lng" type="text"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                            <!-- Textarea -->
                        <div class="form-group">
                            <label class="col-md-2 control-label" for="rtbDescription">
                                <h3>Description</h3>
                            </label>
                            <div class="col-md-8">
                                <div id="rtbDescription">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <h3><label class="col-md-2  control-label" for="radios">Links</label></h3>
                            <div class="col-md-8">
                                <div class="document-table">
                                    <table class="table dataTable no-footer" id="linksTable" role="grid">
                                        <thead>
                                            <tr role="row">
                                                <th aria-controls="linksTable" aria-label="Link Text: activate to sort column descending" aria-sort="ascending" class="sorting_asc" colspan="1" rowspan="1" tabindex="0">Link Text</th>
                                                <th aria-controls="linksTable" aria-label="URL: activate to sort column ascending" class="sorting" colspan="1" rowspan="1" tabindex="0">URL</th>
                                                <th aria-label="Delete" class="sorting_disabled" colspan="1" rowspan="1">Delete</th>
                                                <th aria-label="Edit" class="sorting_disabled" colspan="1" rowspan="1">Edit</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="odd" role="row">
                                                <td class="sorting_1">ASM App</td>
                                                <td>http://azjbbfpspdw1.cloudapp.net/connect</td>
                                                <td>
                                                    <a href="javascript:{}"><i class="fa fa-trash del-link"></i></a>
                                                </td>
                                                <td>
                                                    <a href="javascript:{}"><i class="fa fa-edit edit-link"></i></a>
                                                </td>
                                            </tr>
                                            <tr class="even" role="row">
                                                <td class="sorting_1">Bing Search</td>
                                                <td>http://www.bing.com</td>
                                                <td>
                                                    <a href="javascript:{}"><i class="fa fa-trash del-link"></i></a>
                                                </td>
                                                <td>
                                                    <a href="javascript:{}"><i class="fa fa-edit edit-link"></i></a>
                                                </td>
                                            </tr>
                                            <tr class="odd" role="row">
                                                <td class="sorting_1">Presentations</td>
                                                <td>http://azjbbfpspdw1.cloudapp.net/connect/rackhouse/event/Pages/default.html#documents</td>
                                                <td>
                                                    <a href="javascript:{}"><i class="fa fa-trash del-link"></i></a>
                                                </td>
                                                <td>
                                                    <a href="javascript:{}"><i class="fa fa-edit edit-link"></i></a>
                                                </td>
                                            </tr>
                                            <tr class="even" role="row">
                                                <td class="sorting_1">Register</td>
                                                <td>http://azjbbfpspdw1.cloudapp.net/connect</td>
                                                <td>
                                                    <a href="javascript:{}"><i class="fa fa-trash del-link"></i></a>
                                                </td>
                                                <td>
                                                    <a href="javascript:{}"><i class="fa fa-edit edit-link"></i></a>
                                                </td>
                                            </tr>
                                            <tr class="odd" role="row">
                                                <td class="sorting_1">Speakers</td>
                                                <td>http://azjbbfpspdw1.cloudapp.net/connect/rackhouse/event/Pages/default.html#people</td>
                                                <td>
                                                    <a href="javascript:{}"><i class="fa fa-trash del-link"></i></a>
                                                </td>
                                                <td>
                                                    <a href="javascript:{}"><i class="fa fa-edit edit-link"></i></a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div><!--End Doc Table-->
                                <div class="form-group-double form-group-add-Link">
                                    <div class="form-group col-sm-8">
                                        <label for="txtLinkText">Link Text</label>
                                        <div>
                                            <input class="form-control input-sm" id="txtLinkText" type="text">
                                        </div>
                                        <label for="txtLinkUrl">URL</label>
                                        <div>
                                            <input class="form-control input-sm" id="txtLinkUrl" type="text">
                                        </div>
                                    </div>
                                    <div class="col-xs-12">
                                        <div class="btn-container pull-right">
                                            <button href="javascript:{}" class="action-link btn btn-default" id="btnCloseLinkForm">Close</button>
                                            <button href="javascript:{}" class="action-link btn btn-primary" id="btnSaveLink">Save</button>
                                        </div>
                                    </div>
                                    
                                </div>                                   
                                <a class="add-link" href="#"><i class="icon-plus"></i> Add New Link</a>
                            </div>
                        </div>	
                        
                        <!-- People Area -->
                        <div class="form-group" id="peopleArea">
                            <div class="col-md-2">
                                <h3><label class="control-label">Carousel Images</label></h3>
                            </div>
                            <div class="col-md-8">
                                <div class="document-table">
                                    <div class="dataTables_wrapper no-footer" id="">
                                        <table class="table docs-table dataTable no-footer" id="" role="grid">
                                            <thead>
                                                <tr role="row">
                                                    <th aria-label="" class="sorting_disabled" colspan="1" rowspan="1"></th>
                                                    <th aria-controls="DataTables_Table_0" aria-label="Name: activate to sort column descending" aria-sort="ascending" class="sorting_asc" colspan="1" rowspan="1" tabindex="0">Name</th>
                                                    <th aria-label="Featured" class="sorting_disabled" colspan="1" rowspan="1">Speaker</th>
                                                </tr>
                                            </thead>
                                            <tbody id="docsContainer">
                                                <tr class="odd" role="row">
                                                    <td><img src="/Style%20Library/Images/doc-icons/icpptx.png"></td>
                                                    <td class="sorting_1">
                                                        <a href="http://azjbbfpspdw1.cloudapp.net/_layouts/15/WopiFrame.aspx?sourcedoc=/Program%20Documents/Bartenders%204%20Bourbon%20Faciltators%20guide.pptx">Bartenders 4 Bourbon Faciltators guide.pptx</a>
                                                    </td>
                                                    <td>Goerge Glass</td>
                                                </tr>
                                                <tr class="even" role="row">
                                                    <td><img src="/Style%20Library/Images/doc-icons/icpdf.png"></td>
                                                    <td class="sorting_1">
                                                        <a href="/Program%20Documents/Bartenders%204%20Bourbon%20Toolkit%20Sep%202015.pdf">Bartenders 4 Bourbon Toolkit Sep 2015.pdf</a>
                                                    </td>
                                                    <td>Isaac Newton</td>
                                                </tr>
                                                <tr class="odd" role="row">
                                                    <td><img src="/Style%20Library/Images/doc-icons/icpdf.png"></td>
                                                    <td class="sorting_1">
                                                        <a href="/Program%20Documents/Bartenders%20for%20Bourbon%20Facilitators%20Guide.pdf">Bartenders for Bourbon Facilitators Guide.pdf</a>
                                                    </td>
                                                    <td>Goerge Glass</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>   

                            <div class="person-zone">
                                <div class="form-group-double">
                                    <div class="form-group col-sm-6">
                                        <label>Name</label>
                                        <div>
                                            <input id="person-name" placeholder="Enter Name" class="form-control input-md" type="text">
                                        </div>
                                    </div>
                                    <div class="clearfix"></div>
                                    <div class="form-group col-sm-6">
                                        <div class="col-md-6">
                                            <img id="personPhotoImage" class="img-responsive" src="/_catalogs/masterpage/Resources/img-upload.png">
                                        </div>
                                        <div class="col-md-6">
                                            <p>
                                                <input type="file" id="personPhotoFile" class="program-logo">
                                                <label class="program-logo-label" id="lblPersonPhoto" for="personPhotoFile"><i class="fa fa-upload"></i> Choose a file</label>
                                                <a href="javascript:{}" class="upload-button btn btn-primary" id="uploadPersonPhoto" style="display: none;">Upload</a>
                                            </p>
                                            <a href="javascript:{}" type="button" data-toggle="modal" data-target="#photo-modal">Use Existing Photo</a>
                                        </div>
                                    </div>                    
                                </div>
                                <div class="col-xs-12">
                                    <div class="btn-container pull-right">
                                        <button id="btnPersonCancel" class="btn btn-default" type="button">Cancel</button> 
                                        <button href="javascript:{}" class="action-link btn btn-primary add-person pull-right" id="btnPersonSave">Save</button>
                                    </div>
                                </div>
                            </div>
                            <a class="add-link add-link-person" href="#"><i class="icon-plus"></i> Add New</a>
                            </div>
                        </div>	


                        <!-- Documents area -->
                        <div class="form-group" id="docsArea">
                            <div class="col-md-2">
                                <h3><label class="control-label">Assets</label></h3>
                            </div>
                        
                            <div class="col-md-8">
                                <div class="document-table">
                                    <div class="dataTables_wrapper no-footer" id="">
                                        <table class="table docs-table dataTable no-footer" id="" role="grid">
                                            <thead>
                                                <tr role="row">
                                                    <th aria-label="" class="sorting_disabled" colspan="1" rowspan="1"></th>
                                                    <th aria-controls="DataTables_Table_0" aria-label="Name: activate to sort column descending" aria-sort="ascending" class="sorting_asc" colspan="1" rowspan="1" tabindex="0">Name</th>
                                                    <th aria-label="Featured" class="sorting_disabled" colspan="1" rowspan="1">Speaker</th>
                                                </tr>
                                            </thead>
                                            <tbody id="docsContainer">
                                                <tr class="odd" role="row">
                                                    <td><img src="/Style%20Library/Images/doc-icons/icpptx.png"></td>
                                                    <td class="sorting_1">
                                                        <a href="http://azjbbfpspdw1.cloudapp.net/_layouts/15/WopiFrame.aspx?sourcedoc=/Program%20Documents/Bartenders%204%20Bourbon%20Faciltators%20guide.pptx">Bartenders 4 Bourbon Faciltators guide.pptx</a>
                                                    </td>
                                                    <td>Goerge Glass</td>
                                                </tr>
                                                <tr class="even" role="row">
                                                    <td><img src="/Style%20Library/Images/doc-icons/icpdf.png"></td>
                                                    <td class="sorting_1">
                                                        <a href="/Program%20Documents/Bartenders%204%20Bourbon%20Toolkit%20Sep%202015.pdf">Bartenders 4 Bourbon Toolkit Sep 2015.pdf</a>
                                                    </td>
                                                    <td>Isaac Newton</td>
                                                </tr>
                                                <tr class="odd" role="row">
                                                    <td><img src="/Style%20Library/Images/doc-icons/icpdf.png"></td>
                                                    <td class="sorting_1">
                                                        <a href="/Program%20Documents/Bartenders%20for%20Bourbon%20Facilitators%20Guide.pdf">Bartenders for Bourbon Facilitators Guide.pdf</a>
                                                    </td>
                                                    <td>Goerge Glass</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>   
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>  
            <div class="btn-container pull-right">
                <button id="btnCancel" class="btn btn-default" type="button">Cancel</button> 
                <button id="btnSave" class="btn btn-primary btn-save" type="button">Save</button> 
                <div class="page-status"><h3><i class="fa fa-check" aria-hidden="true"></i>&nbsp;<span id="pageStatusText"></span></h3></div>
            </div>
        </div><!--End Row-->
    </div>
</div><!-- End Beam/bootstrap Container  -->

<!-- Picture Modal -->
<div class="modal fade event-photo-modal" id="photo-modal" tabindex="-1" role="dialog" aria-labelledby="photo-modal">
  <div class="modal-dialog" role="document">
    <div class="modal-content  modal-simple ">
      <div class="modal-body">
         <div id="photoImageList" class="image-list">
         </div>
         <div>
            <input type="text" value="" id="photoImageUrl" class="image-url" />
            <input type="button" value="Apply" id="btnApplyPhoto" class="btn btn-primary" data-dismiss="modal" />
         </div>
      </div>
    </div>
  </div>
</div>

<script>
    // Global Variables
    var ea_webUrl = "";
    var ea_formMode = "NEW";
    var ea_event;
    var ea_person;
    var ea_personId = "";
    var ea_personFormMode = "NEW";
    var ea_linksTable;
    var ea_link;
    var ea_linkFormMode = "NEW";
    var ea_linkRow;

    function getParameterByName(name, url) {
        if (!url) {
            url = window.location.href;
        }
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function ReplaceLanguageInUrl(url, lang) {
        var newUrl =  url.replace("/zhcn/", lang).replace("/zhhk/", lang).replace("/de/", lang).replace("/es/", lang).replace("/fr/", lang).replace("/ja/", lang).replace("/pl/", lang).replace("/pt/", lang).replace("/ru/", lang);
        return newUrl;
    }

    // Set the referring web Url
    function SetWebUrl() {
        var webUrl = getParameterByName("weburl");
        if (webUrl) {
            ea_webUrl = webUrl;
        }
        else {
            ea_webUrl = "";
        }
    }

    // Generate new program ID
    function GeneratePersonId() {
        var date = (new Date()).format("MMddyyyyhhmmss");
    }

    // Upload file procedure
    function UploadFile(fileInput, img, serverRelativeUrlToFolder) {

        // Initiate method calls using jQuery promises.
        // Get the local file as an array buffer.
        var getFile = getFileBuffer();
        getFile.done(function (arrayBuffer) {

            // Add the file to the SharePoint folder.
            var addFile = addFileToFolder(arrayBuffer);
            addFile.done(function (file, status, xhr) {
                var getItem = getListItem(file.d.ListItemAllFields.__deferred.uri);
                getItem.done(function (listItem, status, xhr) {
                    img.attr("src", listItem.d.ServerRelativeUrl);
                    fileInput.val("");
                });
                getItem.fail(UploadError);
            });
            addFile.fail(UploadError);
        });
        getFile.fail(UploadError);

        // Get the local file as an array buffer.
        function getFileBuffer() {
            var deferred = jQuery.Deferred();
            var reader = new FileReader();
            reader.onloadend = function (e) {
                deferred.resolve(e.target.result);
            }
            reader.onerror = function (e) {
                deferred.reject(e.target.error);
            }
            reader.readAsArrayBuffer(fileInput[0].files[0]);
            return deferred.promise();
        }

        // Add the file to the file collection in the Shared Documents folder.
        function addFileToFolder(arrayBuffer) {

            // Get the file name from the file input control on the page.
            var parts = fileInput[0].value.split('\\');
            var fileName = parts[parts.length - 1];

            // Construct the endpoint.
            var fileCollectionEndpoint = String.format(
                "{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files" +
                "/add(overwrite=true, url='{2}')",
                _spPageContextInfo.siteAbsoluteUrl, serverRelativeUrlToFolder, fileName);

            // Send the request and return the response.
            // This call returns the SharePoint file.
            return jQuery.ajax({
                url: fileCollectionEndpoint,
                type: "POST",
                data: arrayBuffer,
                processData: false,
                headers: {
                    "accept": "application/json;odata=verbose",
                    "X-RequestDigest": jQuery("#__REQUESTDIGEST").val()
                }
            });
        }

        // Get the list item that corresponds to the file by calling the file's ListItemAllFields property.
        function getListItem(fileListItemUri) {
            // Send the request and return the response.
            fileListItemUri = fileListItemUri.replace("/ListItemAllFields","");
            return jQuery.ajax({
                url: fileListItemUri,
                type: "GET",
                headers: { "accept": "application/json;odata=verbose" }
            });
        }
    }

    function UploadError(error) {
        console.log(error.responseText);
    }

    function LoadImages(sourceUri, container, image) {
        jQuery.ajax({
            url: sourceUri,
            type: "GET",
            headers: { "accept": "application/json;odata=verbose" },
            success: function(data) {
                var html = "";
                html += "<ul class='image-listing'";
                for (i = 0; i < data.d.results.length; i++) {
                    html +=
                        "<li class='image-tile'>" +
                            "<img class='tile-picture " + image + "-picture' src='" + data.d.results[i].ServerRelativeUrl + "' onclick='pa_programPhotoUrl = jQuery(this).attr(\"src\"); jQuery(\"#" + image + "ImageUrl\").val(jQuery(this).attr(\"src\"))'>" +
                            "<div class='tile-caption'>" + data.d.results[i].Name + "</div>" +
                        "</li>";
                }
                html += "</ul>";
                container.html(html);
            },
            error: function(error) {
                console.log(JSON.stringify(error));
            }
        });
    }

    // Load the image picker dialogs with images availabe in assets folders
    function LoadImagePicker() {
        photoSource = "/SiteAssets/People_Photos";

        var photoUri = _spPageContextInfo.siteAbsoluteUrl + "/_api/web/getfolderbyserverrelativeurl('" + photoSource + "')/files";
        LoadImages(photoUri, jQuery("#photoImageList"), "photo");
    }

    function InitializeForm() {
        // Check if form has input weburl in querystring
        if (ea_webUrl) {
            // Set form mode to edit
            ea_formMode = "EDIT";

            LoadEventData();
            LoadLinks();
            PrintPeopleGrid();
            /*LoadDocuments();*/
        }
    }

    function LoadEventData() {
        var eventUrl = _spPageContextInfo.siteAbsoluteUrl + ReplaceLanguageInUrl(ea_webUrl, "/CONNECT/") + "/_api/web/lists/getbytitle('Events')/items?$top=1&$select=Title,StartDate,OData__EndDate,Location,BeamConnectDescription,PeopleHeader,DocumentsHeader";
        jQuery.ajax({
            url: eventUrl,
            method: "GET",
            headers: {
                accept: "application/json;odata=verbose"
            },
            success: function(data) {
                ea_event = data.d.results[0];
                jQuery("#txtTitle").val(ea_event.Title);
                jQuery("#txtLocation").val(ea_event.Location);
                jQuery("#datepicker-start").val((new Date(ea_event.StartDate)).format("MM/dd/yyyy"));
                jQuery("#datepicker-end").val((new Date(ea_event.OData__EndDate)).format("MM/dd/yyyy"));
                jQuery("#rtbDescription").html(ea_event.BeamConnectDescription);
                jQuery("#txtPeopleHeader").val(ea_event.PeopleHeader);
                jQuery("#txtDocumentsHeader").val(ea_event.DocumentsHeader);
            },
            error: function(err) {
                console.log(JSON.stringify(err));
            }
        });
    }

    function EventInputValid() {
        var valid = true;
        if (!jQuery("#txtTitle").val()) {
            SetStatus("ERROR", "Event title is required.");
            valid = false;
        }
        if (!jQuery("#datepicker-start").val()) {
            SetStatus("ERROR", "Event start date is required.");
            valid = false;
        }
        if (jQuery("#datepicker-end").val()) {
            if ((new Date(jQuery("#datepicker-end"))) < (new Date(jQuery("#datepicker-start")))) {
                SetStatus("ERROR", "Event end date cannot be before start date.");
                valid = false;
            }
        }
        if (!jQuery("#txtPeopleHeader").val()) {
            SetStatus("ERROR", "The people display header text is required.");
            valid = false;
        }
        if (!jQuery("#txtDocumentsHeader").val()) {
            SetStatus("ERROR", "The documents listing header text is required.");
            valid = false;
        }
        return valid;
    }

    function UpdateEvent() {
        ea_event.Title = jQuery("#txtTitle").val();
        ea_event.Location = jQuery("#txtLocation").val();
        ea_event.StartDate = (new Date(jQuery("#datepicker-start").val())).format("yyyy-MM-ddT00:00:00Z");
        ea_event.OData__EndDate = (new Date(jQuery("#datepicker-end").val())).format("yyyy-MM-ddT00:00:00Z");
        ea_event.BeamConnectDescription = jQuery("#rtbDescription").html();
        ea_event.PeopleHeader = jQuery("#txtPeopleHeader").val();
        ea_event.DocumentsHeader = jQuery("#txtDocumentsHeader").val();
    }

    function SaveEvent() {
        if (EventInputValid()) {
            UpdateEvent();
            var eventUrl = ea_event.__metadata.uri;
            jQuery.ajax({
                url: eventUrl,
                method: "POST",
                data: JSON.stringify(ea_event),
                headers: {
                    "accept": "application/json;odata=verbose",
                    "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                    "content-type": "application/json;odata=verbose",
                    "X-HTTP-Method": "MERGE",
                    "If-Match": "*"
                },
                success: function(data) {
                    SetStatus("SUCCESS", "The event has been saved.");
                },
                error: function(err) {
                    SetStatus("ERROR", "An error occurred while saving event. Please check inputs and try again.")
                    console.log(JSON.stringify(err));
                }
            });
        }
    }

    function LoadLinks() {
        linkUrl = _spPageContextInfo.siteAbsoluteUrl + ReplaceLanguageInUrl(ea_webUrl, "/CONNECT/") + "/_api/web/lists/getbytitle('Links')/items?$select=Title,Link&$top=100&$orderby=Title asc";
        var links = [];
        jQuery.ajax({
            url: linkUrl,
            method: "GET",
            headers: {
                "accept": "application/json;odata=verbose"
            },
            success: function(data) {
                jQuery.each(data.d.results, function(i, link) {
                    var linkData = [];
                    linkData.push(
                        link.Title,
                        link.Link.Url,
                        "<a href='javascript:{}'><i class='fa fa-trash del-link' value=\"" + link.__metadata.uri + "\"></i></a>",
                        "<a href='javascript:{}'><i class='fa fa-edit edit-link' value=\"" + link.__metadata.uri + "\"></i></a>"
                    );
                    links.push(linkData);
                });
                ea_linksTable = jQuery("#linksTable").DataTable({
                    data: links,
                    columns: [
                        { title: "Link Text" },
                        { title: "URL" },
                        { title: "Delete", orderable: false },
                        { title: "Edit", orderable: false }
                    ],
                    paging: false,
                    searching: false,
                    info: false,
                    ordering: true
                });
            }
        });
    }

    function SaveLink() {
        if (ea_linkFormMode == "NEW") {
            AddLink();
        }
        if (ea_linkFormMode == "EDIT") {
            UpdateLink();
        }
    }

    function AddLink() {
        linkUrl = _spPageContextInfo.siteAbsoluteUrl + ReplaceLanguageInUrl(ea_webUrl, "/CONNECT/") + "/_api/web/lists/getbytitle('Links')/items";
        var data = {
                "__metadata": {
                    "type": "SP.Data.LinksListItem"
                },
                "Title": jQuery("#txtLinkText").val(),
                "Link": {
                    "__metadata": {
                        "type": "SP.FieldUrlValue"
                    },
                    "Description": jQuery("#txtLinkUrl").val(),
                    "Url": jQuery("#txtLinkUrl").val()
                }
            }
        jQuery.ajax({
            url: linkUrl,
            method: "POST",
            data: JSON.stringify(data),
            headers: {
                "accept": "application/json;odata=verbose",
                "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                "content-type": "application/json;odata=verbose"
            },
            success: function(data) {
                ea_linksTable.row.add([
                        jQuery("#txtLinkText").val(),
                        jQuery("#txtLinkUrl").val(),
                        "<a href='javascript:{}'><i class='fa fa-trash del-link' value=\"" + data.d.__metadata.uri + "\"></i></a>",
                        "<a href='javascript:{}'><i class='fa fa-edit edit-link' value=\"" + data.d.__metadata.uri + "\"></i></a>"
                    ]).draw();
                
                ClearLinkForm();
            },
            error: function(err) {
                console.log(JSON.stringify(err));
            }
        });
    }

    function UpdateLink() {
        var linkUrl = ea_link.__metadata.uri;
        ea_link.Title = jQuery("#txtLinkText").val();
        ea_link.Link.Description = jQuery("#txtLinkUrl").val();
        ea_link.Link.Url = jQuery("#txtLinkUrl").val();
        jQuery.ajax({
            url: linkUrl,
            method: "POST",
            data: JSON.stringify(ea_link),
            headers: {
                "accept": "application/json;odata=verbose",
                "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                "content-type": "application/json;odata=verbose",
                "X-HTTP-Method": "MERGE",
                "If-Match": "*"
            },
            success: function(data) {
                if (ea_linkRow) {
                    ea_linksTable.row(ea_linkRow).data([
                        jQuery("#txtLinkText").val(),
                        jQuery("#txtLinkUrl").val(),
                        "<a href='javascript:{}'><i class='fa fa-trash del-link' value=\"" + ea_link.__metadata.uri + "\"></i></a>",
                        "<a href='javascript:{}'><i class='fa fa-edit edit-link' value=\"" + ea_link.__metadata.uri + "\"></i></a>"
                    ]).draw();
                }
                ClearLinkForm();
            },
            error: function(err) {
                console.log(JSON.stringify(err));
            }
        });
    }

    function ClearLinkForm() {
        jQuery('.form-group-add-Link').hide();
        jQuery("#txtLinkText").val("");
        jQuery("#txtLinkUrl").val("");
    }

    function DeleteLink(elem) {
        var element = jQuery(elem);
        element.removeClass("fa-trash");
        element.addClass("fa-spinner").addClass("fa-spin").addClass("fa-fw");
        var parentRow = jQuery(elem).parents("tr");
        var linkUrl = element.attr("value");
        jQuery.ajax({
            url: linkUrl,
            method: "POST",
            headers: {
                "accept": "application/json;odata=verbose",
                "X-RequestDigest": jQuery('#__REQUESTDIGEST').val(),
                "content-type": "application/json;odata=verbose",
                "X-HTTP-Method": "DELETE",
                "If-Match": "*"
            },
            success: function(data) {
                ea_linksTable.row(parentRow).remove().draw();
            },
            error: function(err) {
                console.log(JSON.stringify(err));
            }
        });
    }

    function SetStatus(type, message) {
        switch(type) {
            case "SUCCESS":
                if (jQuery("#pageStatusIcon").hasClass("fa-remove")) {
                    jQuery("#pageStatusIcon").removeClass("fa-remove");
                }
                if (!jQuery("#pageStatusIcon").hasClass("fa-check")) {
                    jQuery("#pageStatusIcon").addClass("fa-check");
                }
                jQuery("#pageStatusIcon").show();
                if (jQuery(".page-status").hasClass("text-warning")) {
                    jQuery(".page-status").removeClass("text-warning");
                }
                if (!jQuery(".page-status").hasClass("text-success")) {
                    jQuery(".page-status").addClass("text-success");
                }
                break;
            case "ERROR":
                if (jQuery("#pageStatusIcon").hasClass("fa-check")) {
                    jQuery("#pageStatusIcon").removeClass("fa-check");
                }
                if (!jQuery("#pageStatusIcon").hasClass("fa-remove")) {
                    jQuery("#pageStatusIcon").addClass("fa-remove");
                }
                jQuery("#pageStatusIcon").show();
                if (jQuery(".page-status").hasClass("text-success")) {
                    jQuery(".page-status").removeClass("text-success");
                }
                if (!jQuery(".page-status").hasClass("text-warning")) {
                    jQuery(".page-status").addClass("text-warning");
                }
                break;
            default:
                jQuery("#pageStatusIcon").hide();
        }

        jQuery("#pageStatusText").text(message);
        jQuery(".page-status").show();
    }

    function ClearStatus() {
        jQuery(".page-status").hide();
    }

    function InitiateDescriptionBox() {
        jQuery("#rtbDescription").easyEditor({
            buttons: ['bold', 'italic', 'link', 'h2', 'h3', 'h4', 'alignleft', 'aligncenter', 'alignright', 'quote', 'code', 'image', 'youtube', 'x'],
            buttonsHtml: {
                'bold': '<i class="fa fa-bold"></i>',
                'italic': '<i class="fa fa-italic"></i>',
                'link': '<i class="fa fa-link"></i>',
                'header-2': '<i class="fa fa-header"></i>2',
                'header-3': '<i class="fa fa-header"></i>3',
                'header-4': '<i class="fa fa-header"></i>4',
                'align-left': '<i class="fa fa-align-left"></i>',
                'align-center': '<i class="fa fa-align-center"></i>',
                'align-right': '<i class="fa fa-align-right"></i>',
                'quote': '<i class="fa fa-quote-left"></i>',
                'code': '<i class="fa fa-code"></i>',
                'insert-image': '<i class="fa fa-picture-o"></i>',
                'insert-youtube-video': '<i class="fa fa-youtube"></i>',
                'remove-formatting': '<i class="fa fa-ban"></i>'
            }
        });
    }

    function InitiatePersonDescriptionBox() {
        jQuery("#rtbPersonDescription").easyEditor({
            buttons: ['bold', 'italic', 'link', 'h2', 'h3', 'h4', 'alignleft', 'aligncenter', 'alignright', 'quote', 'code', 'image', 'youtube', 'x'],
            buttonsHtml: {
                'bold': '<i class="fa fa-bold"></i>',
                'italic': '<i class="fa fa-italic"></i>',
                'link': '<i class="fa fa-link"></i>',
                'header-2': '<i class="fa fa-header"></i>2',
                'header-3': '<i class="fa fa-header"></i>3',
                'header-4': '<i class="fa fa-header"></i>4',
                'align-left': '<i class="fa fa-align-left"></i>',
                'align-center': '<i class="fa fa-align-center"></i>',
                'align-right': '<i class="fa fa-align-right"></i>',
                'quote': '<i class="fa fa-quote-left"></i>',
                'code': '<i class="fa fa-code"></i>',
                'insert-image': '<i class="fa fa-picture-o"></i>',
                'insert-youtube-video': '<i class="fa fa-youtube"></i>',
                'remove-formatting': '<i class="fa fa-ban"></i>'
            }
        });
    }

    function PrintPeopleGrid() {
        var url = _spPageContextInfo.siteAbsoluteUrl + ReplaceLanguageInUrl(ea_webUrl, "/CONNECT/") + "/_api/web/lists/getbytitle('People')/items?$select=Title,PersonID,ArticleByLine,Role,BeamConnectDescription,PersonPhoto,TwitterHandle,FacebookLink,InstagramLink,LinkedInLink&$top=100&$orderby=Order1 asc";
        jQuery.ajax({
            url: url,
            type:"GET",
            headers: {
                Accept: "application/json;odata=verbose"
            },
            success: function(data) {
                var personId = "";
                var name = "";
                var byline = "";
                var role = "";
                var description = "";
                var photoUrl = "";
                var twitterHandle = "";
                var facebookLink = "";
                var instagramLink = "";
                var linkedInLink = "";
                var roleArray = [];

                var primaryHTML = "";
                var modalHTML = "";

                jQuery.each(data.d.results, function(i, n) {
                    personId = n.PersonID;
                    name = n.Title;
                    byline = n.ArticleByLine;
                    role = n.Role; 
                    description = n.BeamConnectDescription; 
                    photoUrl = n.PersonPhoto.Url;
                    twitterHandle = n.TwitterHandle;
                    facebookLink = n.FacebookLink;
                    instagramLink = n.InstagramLink;
                    linkedInLink = n.LinkedInLink;

                    primaryHTML +=
                    "<li class=\"people-grid-person ui-state-default\">" + 
                        "<input type=\"hidden\" value=\"" + n.__metadata.uri + "\" />" + 
                        "<a href=\"javascript:{}\" class=\"person-modal-launcher\" id=\"" + personId + "\" data-toggle=\"modal\" data-target=\"#personModal\">" +
                            "<img src=\"" + photoUrl + "\" class=\"img-responsive\"/>" +
                            "<div class=\"people-grid-overlay\">" +
                                "<h2 class=\"people-name\">" + name + "</h2>";
                    if (byline) {
                        primaryHTML += 
                                "<span class=\"people-byline\">" + byline + "</span>";
                    }
                    primaryHTML += 
                                "<span class=\"people-description\">" + role + "</span>" + 
                            "</div>" + 
                        "</a>" + 
                    "</li>";
                });
                jQuery("#peopleGridList").html(primaryHTML);

                // Add handler to show the person form loaded when a person is selected
                jQuery(".people-grid-person").on("click", function() {
                    var personUrl = jQuery(this).find("input[type=hidden]").val() + "?$select=Title,PersonID,Role,ArticleByLine,BeamConnectDescription,PersonPhoto,TwitterHandle,FacebookLink,InstagramLink,LinkedInLink";
                    jQuery.ajax({
                        url: personUrl,
                        method: "GET",
                        headers: {
                            "accept": "application/json;odata=verbose"
                        },
                        success: function(data) {
                            ea_personFormMode = "EDIT";
                            ea_person = data.d;
                            jQuery("#person-name").val(data.d.Title);
                            jQuery("#person-role").val(data.d.Role);
                            jQuery("#person-byline").val(data.d.ArticleByLine);
                            jQuery("#rtbPersonDescription").html(data.d.BeamConnectDescription);
                            jQuery("#twitterHandle").val(data.d.TwitterHandle);
                            jQuery("#facebookLink").val(data.d.FacebookLink);
                            jQuery("#instagramLink").val(data.d.InstagramLink);
                            jQuery("#linkedInLink").val(data.d.LinkedInLink);
                            jQuery("#personPhotoImage").attr("src", data.d.PersonPhoto.Url);

                            jQuery(this).addClass('person-selected');
                            jQuery('.person-zone').show();
                        },
                        error: function(err) {
                            console.log(JSON.stringify(err));
                        }
                    });
                });
            },
            error:function(d) {
                console.log(JSON.stringify(d));
            }
        });
    }

    function SavePerson() {
        switch(ea_personFormMode) {
            case "NEW":
                AddPerson();
                break;
            case "EDIT":
                EditPerson();
                break;
        }
    }

    function GetFormData() {
        var data = {
            "__metadata": {
                "type": "SP.Data.PeopleListItem"
            },
            "Title": jQuery("#person-name").val(),
            "PersonID": ea_personId,
            "Role": jQuery("#person-role").val(),
            "ArticleByLine": jQuery("#person-byline").val(),
            "BeamConnectDescription": jQuery("#rtbPersonDescription").html(),
            "PersonPhoto": {
                "__metadata": {
                    "type": "SP.FieldUrlValue"
                },
                "Description": jQuery("#personPhotoImage").attr("src").replace(_spPageContextInfo.siteAbsoluteUrl, ""),
                "Url": jQuery("#personPhotoImage").attr("src").replace(_spPageContextInfo.siteAbsoluteUrl, "")
            },
            "TwitterHandle": jQuery("#twitterHandle").val(),
            "FacebookLink": jQuery("#facebookLink").val(),
            "InstagramLink": jQuery("#instagramLink").val(),
            "LinkedInLink": jQuery("#linkedInLink").val()
        }
        return data;
    }

    //Save Function for New Person
    function AddPerson() {
        var requestUrl = _spPageContextInfo.siteAbsoluteUrl + ReplaceLanguageInUrl(ea_webUrl, "/CONNECT") + "/_api/web/lists/GetByTitle('People')/items";
        jQuery.ajax({
            url: requestUrl,
            method: "POST",
            data: JSON.stringify(GetFormData()),
            headers: {
                "accept": "application/json;odata=verbose",
                "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                "content-type": "application/json;odata=verbose"
            },
            success: function(data) {
                SetStatus("SUCCESS", "The person has been added.");
                ClearPersonForm();
            },
            error: function(err) {
                SetStatus("ERROR", "An error occurred while adding the person. Please check the inputs and retry.");
                console.log(JSON.stringify(err));
            }
        });
    }

    // Update the person object with values from the form
    function UpdatePerson() {
        ea_person.Title = jQuery("#person-name").val();
        ea_person.Role = jQuery("#person-role").val();
        ea_person.ArticleByLine = jQuery("#person-byline").val();
        ea_person.BeamConnectDescription = jQuery("#rtbPersonDescription").html();
        ea_person.PersonPhoto.Description = jQuery("#personPhotoImage").attr("src").replace(_spPageContextInfo.siteAbsoluteUrl, "");
        ea_person.PersonPhoto.Url = jQuery("#personPhotoImage").attr("src").replace(_spPageContextInfo.siteAbsoluteUrl, "");
        ea_person.TwitterHandle = jQuery("#twitterHandle").val();
        ea_person.FacebookLink = jQuery("#facebookLink").val();
        ea_person.InstagramLink = jQuery("#instagramLink").val();
        ea_person.LinkedInLink = jQuery("#linkedInLink").val();
    }

    //Edit function for an exisitng Person
    function EditPerson(listName) {
        UpdatePerson();
        jQuery.ajax({
            url: ea_person.__metadata.uri,
            method: "POST",
            data: JSON.stringify(ea_person),
            headers: {
                "accept": "application/json;odata=verbose",
                "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                "content-type": "application/json;odata=verbose",
                "X-HTTP-Method": "MERGE",
                "If-Match": "*"
            },
            success: function() {
                SetStatus("SUCCESS", "Changes to the person have been saved.");
                ClearPersonForm();
            },
            error: function(err) {
                SetStatus("ERROR", "An error occurred while saving the person. Please check the inputs and retry.");
                console.log(JSON.stringify(err));
            }
        });
    }

    function ClearPersonForm() {
        jQuery('.person-zone').hide();
        jQuery("#person-name").val("");
        jQuery("#person-role").val("");
        jQuery("#person-byline").val("");
        jQuery("#rtbPersonDescription").html("");
        jQuery("#twitterHandle").val("");
        jQuery("#facebookLink").val("");
        jQuery("#instagramLink").val("");
        jQuery("#linkedInLink").val("");
        jQuery("#personPhotoImage").attr("src", "/_catalogs/masterpage/Resources/img-upload.png");
    }

    function AddHandlers() {

        // Set date pickers
        jQuery("#datepicker-start").datepicker();
        jQuery("#datepicker-end").datepicker();
        jQuery("#anim").on("change", function() {
            jQuery("#datepicker-end").datepicker("option", "showAnim", jQuery(this).val());
            jQuery("#datepicker-start").datepicker("option", "showAnim", jQuery(this).val());
        });

        // Handler for program photo file input
        jQuery("#personPhotoFile").change(function() {
            var text = jQuery("#personPhotoFile").val();
            if (text == "") {
                jQuery("#uploadPersonPhoto").hide();
            }
            else {
                jQuery("#uploadPersonPhoto").show();
            }
            var filename = text.substr(text.lastIndexOf("\\") + 1);
            jQuery("#lblPersonPhoto").text(filename);
        });

        // Handler to apply existing photo
        jQuery("#btnApplyPhoto").on("click", function() {
            jQuery("#personPhotoImage").attr("src", jQuery("#photoImageUrl").val());
        });

        // Add event cancel button action
        jQuery("#btnCancel").on("click", function() {
            window.location.href = ea_webUrl;
        });

        // Add event handler for the event save button
        jQuery("#btnSave").on("click", function() {
            SaveEvent();
        });

        // Add handler to show link form when Add New link is clicked
        jQuery(document).on("click", ".add-link", function() {
            jQuery("#txtLinkText").val("");
            jQuery("#txtLinkUrl").val("");
            jQuery(".form-group-add-Link").show();
        });

        // Add handler to close link form when close button is clicked
        jQuery("#btnCloseLinkForm").on("click", function(){
            jQuery("#txtLinkText").val("");
            jQuery("#txtLinkUrl").val("");
            jQuery(".form-group-add-Link").hide();
        });

        // Add handler to save link
        jQuery("#btnSaveLink").on("click", function() {
            SaveLink();
        });

        // Add handler to delete link
        jQuery(document).on("click", ".del-link", function() {
            DeleteLink(this);
        });

        // Add handler to edit link
        jQuery(document).on("click", ".edit-link", function(e) {
            ea_linkFormMode = "EDIT";
            ea_linkRow = jQuery(e.target).parents("tr");
            var linkUrl = jQuery(e.target).attr("value") + "?$select=Title,Link";
            jQuery.ajax({
                url: linkUrl,
                method: "GET",
                headers: {
                    "accept": "application/json;odata=verbose"
                },
                success: function(data) {
                    ea_link = data.d;
                    jQuery("#txtLinkText").val(ea_link.Title);
                    jQuery("#txtLinkUrl").val(ea_link.Link.Url);
                    jQuery(".form-group-add-Link").show();
                },
                error: function(err) {
                    console.log(JSON.stringify(err));
                }
            });
        });

        // Set the people grid to be sortable
        jQuery("#peopleGridList").sortable({
            update: function(event, ui) {
                var items = jQuery(this).children("li");
                items.each(function(index, element) {
                    var item = jQuery(this);
                    var newOrder = item.index() + 1;
                    var reqUrl = item.find("input[type=hidden]").val();
                    jQuery.ajax({
                        url: reqUrl,
                        method: "POST",
                        data: JSON.stringify({
                            "__metadata": {
                                "type": "SP.Data.PeopleListItem"
                            },
                            "Order1": newOrder.toString()
                        }),
                        headers: {
                            "accept": "application/json;odata=verbose",
                            "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                            "content-type": "application/json;odata=verbose",
                            "X-HTTP-Method": "MERGE",
                            "If-Match": "*"
                        },
                        success: function() {
                            console.log("Updated order of items.");
                        },
                        error: function(err) {
                            console.log(JSON.stringify(err));
                        }
                    });
                });
            }
        });
        jQuery("#peopleGridList").disableSelection();

        // Add handler to the add link for a new person
        jQuery(".add-link-person").on("click", function() {
            ea_personFormMode = "NEW";
            ea_personId = GeneratePersonId();
            jQuery('.person-zone').show();
        });

        // Add handler to person form cancel button
        jQuery("#btnPersonCancel").on("click", function() {
            ClearPersonForm();
        });

        // Add handler to save button on person form
        jQuery("#btnPersonSave").on("click", function() {
            SavePerson();
        });
    }

    jQuery(document).ready(function() {
        SetWebUrl();
        InitiateDescriptionBox();
        InitiatePersonDescriptionBox();
        InitializeForm();
        LoadImagePicker();
        AddHandlers();
    });
</script><head><title></title></head>