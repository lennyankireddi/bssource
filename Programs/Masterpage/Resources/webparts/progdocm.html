<link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.13/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="//cdn.datatables.net/1.10.13/js/jquery.dataTables.js"></script>
<h3>Content</h3>
<div class="document-table">
    <table class="table docs-table">
        <thead>
            <tr>
                <th></th>
                <th>Name</th>
                <th>Featured</th>
            </tr>
        </thead>
        <tbody id="docsContainer">
            
        </tbody>
    </table>
</div>

<!-- Document Library link -->
<div class="program-id-message">Please use the Program ID <span id="progIdHolder"></span> for document associations.</div>
<a href="#" type="button" data-toggle="modal" data-target="#document-modal">
    <h2 class="addNew-doc-link"><i aria-hidden="true" class="fa fa-gear" >           
    </i> Manage Documents</h2>
</a>

<!-- Document Modal -->
<div class="modal fade" id="document-modal" tabindex="-1" role="dialog" aria-labelledby="document-modal">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content  modal-simple ">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><i class="fa fa-times"></i></button>
        <h3 class="modal-title"><i aria-hidden="true" class="fa fa-gear" >           
                    </i>  Manage Program Documents</h3>
      </div>
      <div class="modal-body">
            <iframe src="/Program%20Documents/Forms/AllItems.aspx"></iframe>

      </div>
      <div class="modal-footer">
        <div class="btn-container">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    function getParameterByName(name, url) {
	    if (!url) {
	      url = window.location.href;
	    }
	    name = name.replace(/[\[\]]/g, "\\$&");
	    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
	        results = regex.exec(url);
	    if (!results) return null;
	    if (!results[2]) return '';
	    return decodeURIComponent(results[2].replace(/\+/g, " "));
	}

    function GetDocIcon(extension)
    {
        switch(extension)
        {
            case "aspx":
                return "/_layouts/15/images/icgen.gif";
                break;
            case "pptx":
                return "/_layouts/15/images/icpptx.png";
                break;
            case "ppt":
                return "/_layouts/15/images/icpptx.png";
                break;
            case "doc":
                return "/_layouts/15/images/icdocx.png";
                break;
            case "docx":
                return "/_layouts/15/images/icdocx.png";
                break;
            case "xls":
                return "/_layouts/15/images/icxlsx.png";
                break;
            case "xlsx":
                return "/_layouts/15/images/icxlsx.png";
                break;
            case "pdf":
                return "/_layouts/15/images/icpdf.png";
                break;
            case "jpg":
                return "/_layouts/15/images/icjpg.gif";
                break;
            case "png":
                return "/_layouts/15/images/icjpg.gif";
                break;
            default:
                return "/_layouts/15/images/icgen.gif";
        }
    }

    function GetFileType (ext) {
        switch (ext) {
            case "ASPX":
                return "Page";
                break;
            case "PPTX":
                return "PowerPoint";
                break;
            case "PPT":
                return "PowerPoint";
                break;
            case "DOCX":
                return "Document";
                break;
            case "DOC":
                return "Document";
                break;
            case "XLSX":
                return "Spreadsheet";
                break;
            case "XLSX":
                return "Spreadsheet";
                break;
            case "PDF":
                return "PDF";
                break;
            case "JPG":
                return "Image";
                break;
            case "PNG":
                return "Image";
                break;
            case "MP4":
                return "Video";
                break;
            case "MOV":
                return "Video";
                break;
            default:
                return "File";
                break;
        }
    }

    function IsOfficeDocument(extension) {
        switch(extension.toUpperCase()) {
            case "PPT":
                return true;
                break;
            case "PPTX":
                return true;
            case "DOC":
                return true;
                break;
            case "DOCX":
                return true;
            case "XLS":
                return true;
                break;
            case "XLSX":
                return true;
            default:
                return false;
        }
    }

    function IsVideoFile(extension) {
        switch (extension.toUpperCase()) {
            case "MP4":
                return true;
            case "MOV":
                return true;
            default:
                return false;
        }
    }

    function ToggleFeatured(tack) {
        var url = jQuery(tack).attr("value");
        jQuery.ajax({
            url: url,
            method: "GET",
            headers: {
                "Accept": "application/json;odata=verbose"
            },
            success: function(result) {
                var match = result.d.__metadata.etag;
                var featured = result.d.Featured;
                var data = { "__metadata": { "type": "SP.Data.Program_x0020_DocumentsItem" }, "Featured": false }
                if (!featured) {
                    data.Featured = true;
                }
                jQuery.ajax({
                    url: url,
                    method: "POST",
                    data: JSON.stringify(data),
                    headers: {
                        "Accept": "application/json;odata=verbose",
                        "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                        "content-type": "application/json;odata=verbose",
                        "X-HTTP-Method": "MERGE",
                        "If-Match": match
                    },
                    success: function(data) {
                        if (!featured) {
                            if (!jQuery(tack).hasClass("icon-featured")) {
                                jQuery(tack).addClass("icon-featured");
                            }
                        }
                        else {
                            if (jQuery(tack).hasClass("icon-featured")) {
                                jQuery(tack).removeClass("icon-featured");
                            }
                        }
                    },
                    error: function(err) {
                        console.log(JSON.stringify(err));
                    }
                });
            },
            error: function(err) {
                console.log(JSON.stringify(err));
            }
        });
    }

    var programId = getParameterByName("progid");
    var url = _spPageContextInfo.siteAbsoluteUrl + "/_api/web/lists/getbytitle('Program Documents')/items?$select=File,Featured&$filter=substringof('" + programId + "', Programs)&$expand=File";
    query = "";
    jQuery.ajax({
        url: url + query,
        method: "GET",
        headers: { 
                    "Accept": "application/json; odata=verbose",
                },
        success: function (data) {
            var html = "";
            var docName = "";
            var extension = "";
            var docUrl = "";
            var itemUri = "";
            var result;
            for (i = 0; i < data.d.results.length; i++) {
                result = data.d.results[i];
                docName = result.File.Name;
                extension = docName.substr(docName.lastIndexOf('.') + 1);
                itemUri = result.__metadata.uri;

                if (IsOfficeDocument(extension)) {
                    docUrl = _spPageContextInfo.webAbsoluteUrl + "/_layouts/15/WopiFrame.aspx?sourcedoc=" + result.File.ServerRelativeUrl;
                }
                else if (IsVideoFile(extension)) {
                    docUrl = _spPageContextInfo.siteAbsoluteUrl + "/Pages/VideoPlayer.aspx?videopath=" + result.File.ServerRelativeUrl;
                }
                else {
                    docUrl = result.File.ServerRelativeUrl;
                }
                html +=
                    '<tr>' +
                        '<td><img src="' + GetDocIcon(extension) + '"></td>' +
                        '<td><a href="' + docUrl + '">' + docName + '</a></td>';
                if (result.Featured) {
                    html +=
                        '<td><i class="fa fa-thumb-tack icon-featured" aria-hidden="true" value="' + itemUri + '"></i></td>';
                }
                else {
                    html +=
                        '<td><i class="fa fa-thumb-tack" aria-hidden="true" value="' + itemUri + '"></i></td>';
                }
                html +=
                    '</tr>';
            }
            jQuery("#docsContainer").html(html);

            // Turn table into sortable datatable
            jQuery(".docs-table").DataTable({
                "paging": false,
                "searching": false,
                "info": false,
                "ordering": true,
                "order": [[1, "asc"]],
                "columnDefs": [
                    { "orderable": false, "targets": 0 },
                    { "orderable": false, "targets": 2 },
                ]
            });

            // Add tack handler
            jQuery(".fa-thumb-tack").on("click", function() {
                ToggleFeatured(jQuery(this));
            });
        },
        error: function(err) {
            console.log(JSON.stringify(err));
        }
    });
</script>